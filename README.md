# DiscusScan

Система мониторинга упоминаний (форумы, Telegram, тематические сайты) с умным агентом OpenAI.

## Ключевые возможности
- Multi-scope сканер:
  - Discovery: поиск новых релевантных доменов (кандидатов) — сохраняются как inactive (candidate).
  - Per-domain: таргетированные запросы по активным доменам (site: + семантические вариации).
  - Forums scope: широкий сбор обсуждений (threads / topics / Q&A / issues) вне соцсетей.
  - Telegram scope: поиск постов / обсуждений в t.me (режим any или только обсуждаемые). 
- Инкрементальная логика: last_scan_at ограничивает свежесть, сбрасывается при очистке.
- Уведомления в Telegram (HTML, статистика, примеры новых ссылок, кнопка перехода в панель).
- Smart Prompt Wizard (двухэтапный мастер): анализирует задачу, задаёт уточняющие вопросы, предлагает языки и регионы.
- Автоматическое обнаружение и добавление новых доменов (как кандидаты — не активируются сразу).
- Фильтрация и дедупликация ссылок, каноникализация URL.
- Гибкая настройка периодичности (CRON или CLI запуск).
- Логи OpenAI запросов (запрос / ответ / fallback стадии).

## Архитектура сканирования
Файл scan.php формирует набор jobs:
1. discover_forums — разведка новых доменов (исключая уже известные).
2. domain:<host> — индивидуальные targeted запросы по каждому активному домену.
3. forums:<REGION?> — широкий сбор релевантных обсуждений.
4. telegram:<REGION?> — поиск постов в Telegram.

Каждый job = один вызов OpenAI Responses API с инструментом web_search. Пайплайн:
- strict JSON schema → relaxed JSON → текстовый fallback (tab-separated) → парсинг.
- Аннотация ссылок __job и __purpose (discovery/per_domain/forums/telegram).
- Новые домены из discovery помечаются candidate (is_active=0) для последующего одобрения.

## Таблицы (основные)
- sources (host, is_active, note)
- links (url, title, times_seen, first_found, last_seen, source_id)
- scans (история запусков)

## Требования
- PHP 8.1+ (рекомендовано)
- Расширения: curl, pdo_mysql, mbstring, json
- MySQL / MariaDB

## Установка
1. Клонируйте репозиторий:
   git clone https://github.com/you/DiscusScan.git
2. Создайте БД и пользователя.
3. Откройте installer.php в браузере (или импортируйте SQL если предусмотрено отдельно).
4. Перейдите в settings.php, задайте:
   - OpenAI API Key
   - Модель (gpt-5-mini по умолчанию)
   - Промпт (или используйте «Мастер»)
   - Языки / Регионы (опционально)
   - Telegram bot token + chat id (если нужны уведомления)
   - Включите нужные scope (домены / форумы / Telegram)

## Запуск сканера
- Через браузер (если настроен cron_secret):
  https://your-host/path/scan.php?secret=XXXXX
- Через CLI:
  php scan.php

Рекомендуемый CRON (каждые 15 минут):
*/15 * * * * /usr/bin/php /path/to/DiscusScan/scan.php >/dev/null 2>&1

## Telegram уведомления
Формат содержит:
- Новые ссылки (до 3 примеров)
- Сводку: total / new / уникальные домены
- Статистику по job’ам (название + count + HTTP статус)
- Кнопка «Открыть панель»

## Очистка данных
Кнопка в settings:
- TRUNCATE: links, topics, scans, runs, domains, sources
- Сбрасывает last_scan_at (следующий проход = полный поиск)
- Настройки и ключи сохраняются

## Smart Prompt Wizard
1. Анализирует ввод и генерирует уточняющие вопросы (если нужно).
2. Генерирует финальный мониторинговый промпт и предлагает языки/регионы.

## Механизм incremental свежести
- last_scan_at обновляется по завершении скана
- При очистке сбрасывается
- nowPref формирует soft-рекомендацию модели на свежие документы

## Логирование
Файл журналов (APP_LOG в db.php):
- OpenAI REQUEST [...]
- OpenAI RESPONSE [...]
- RELAXED / FALLBACK стадии
Содержимое prettified при JSON.

## Безопасность
- scan.php требует секрет (cron_secret) или логин
- Не публикуйте cron_secret публично
- API ключ хранится в settings (рекомендуется ограничить права системного пользователя БД)

## Roadmap / идеи
- Adaptive per-domain backoff (уменьшение частоты если нет новых ссылок)
- Дополнительные фильтры ссылок (pattern allow/deny)
- UI модерация candidate доменов (bulk activate)
- Экспорт (CSV / JSONL)
- Метрики (время ответа API, распределение статусов)

## Обновление версии
Версия хранится в version.php (APP_VERSION). Теги git соответствуют релизам (semver-подобно). Текущая: 1.2.37

## Лицензия
(Укажите лицензию — например MIT / Proprietary)

## Быстрый старт (TL;DR)
1. Настроить .env / settings (API ключ + промпт)
2. Включить нужные scope
3. Добавить источники (или подождать discovery)
4. Настроить CRON
5. Подключить Telegram
6. Анализировать найденные ссылки в панели

---
Если нужен английский вариант README или auto-changelog — напишите.
